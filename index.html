<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>timed</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Code+Pro"
    />
    <script type="text/javascript" src="lib/theme.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
  </head>
  <body>
    <script>
      let theme = new Theme();
      theme.install();
      theme.start();
    </script>
    <div id="app">
      <main>
        <div id="wrapper">
          <div id="todo-add" @click="isFormOpened = !isFormOpened">
            <!-- TODO: сделать анимацию при открытии и закрытии формы плавной -->
            <i
              class="las la-plus"
              :style="isFormOpened ? 'transform: rotate(45deg)' : ''"
            ></i>
          </div>
          <transition-group name="list" tag="div" id="todo-list">
            <todo-form
              v-if="isFormOpened"
              @request-todo-creation="addTodo"
            ></todo-form>
            <todo-item
              v-if="todos.length"
              v-for="todo in sortedTodos"
              :key="todo.id"
              :todo="todo"
              @request-todo-deletion="deleteTodo"
            ></todo-item>
            <p v-else>No todos yet!</p>
          </transition-group>
        </div>
      </main>
      <footer>
        <!-- TODO: что-то тут реализовать -->
        <div>Contact me</div>
        <div>Credits</div>
      </footer>
    </div>
    <script>
      const TodoApp = {
        data() {
          return {
            appName: "timed",
            isFormOpened: false,
            priority: ["active", "paused", "new", "done"],
            // TODO: сохранять в localStorage хотя бы
            todos: [
              {
                id: 1,
                title: "Study CSS",
                maxDuration: 60,
                currentDuration: 50,
                type: "timer",
                status: "paused",
              },
              {
                id: 2,
                title: "Workout",
                maxDuration: 2000,
                currentDuration: 304,
                type: "timer",
                status: "paused",
              },
              {
                id: 3,
                title: "Clean up the desk",
                maxDuration: 900,
                currentDuration: 0,
                type: "timer",
                status: "new",
              },
              {
                id: 4,
                title: "Buy a book",
                type: "text",
                status: "new",
              },
              {
                id: 5,
                title: "Make a sketch of the app",
                maxDuration: 900,
                currentDuration: 900,
                type: "timer",
                status: "done",
              },
              {
                id: 6,
                title: "Schedule an appointment to the vet",
                type: "text",
                status: "done",
              },
              {
                id: 7,
                title: "Feed the cat",
                type: "text",
                status: "done",
              },
              {
                id: 8,
                title: "Check visa application status",
                type: "text",
                status: "done",
              },
              {
                id: 9,
                title: "Schedule an appointment to the dentist",
                type: "text",
                status: "done",
              },
            ],
          };
        },
        computed: {
          // TODO: реализовать сортировку правильно
          sortedTodos: function () {
            // Новый массив нужен чтобы работала анимация при пересортировке
            return [...this.todos].sort((a, b) => {
              let ia = this.priority.indexOf(a.status);
              let ib = this.priority.indexOf(b.status);
              if (ia < ib) {
                return -1;
              }
              if (ia > ib) {
                return 1;
              }
              return 0;
            });
          },
        },
        methods: {
          // maxDuration только если type - timer
          addTodo(todoTitle, todoType, todoMaxDuration) {
            const todoId = Math.max(...this.todos.map((o) => o.id)) + 1;
            const newTodo = {
              id: todoId,
              title: todoTitle,
              type: todoType,
              status: "new",
            };
            if (todoType === "timer") {
              newTodo.currentDuration = 0;
              newTodo.maxDuration = todoMaxDuration;
            }

            this.isFormOpened = false;
            this.todos.push(newTodo);
          },
          deleteTodo(todoId) {
            const index = this.todos.findIndex((todo) => {
              return todo.id === todoId;
            });
            this.todos.splice(index, 1);
          },
        },
      };
      const app = Vue.createApp(TodoApp);

      app.component("todo-item", {
        template: `
                <div
                  :class="{
                  'todo-item': todo.title,
                  'done': todo.status === 'done',
                  'active': todo.status === 'active',
                }"
                >
                  <i
                    :class="{
                  'lar': todo.title,
                  'la-play-circle': todo.type === 'timer' && todo.status !== 'active',
                  'la-pause-circle': todo.type === 'timer' && todo.status === 'active',
                  'la-circle': todo.type === 'text' && todo.status === 'new',
                  'la-check-circle' : todo.status === 'done',
                }"
                    @click="todo.type === 'timer' ? (todo.status === 'active' ? pauseTimer() : startTimer()) : toggleStatus()"
                  ></i>
                  <span v-text='todo.title' class='todo-title'></span>
                  <span v-if="todo.type === 'timer'" class='todo-left' v-text="secondsToTime(todo.maxDuration-todo.currentDuration) + ' left'"></span>
                  <i class='lar la-trash-alt' @click="$emit('requestTodoDeletion', todo.id)"></i>
                </div>
              `,
        name: "TodoItem",
        // TODO: проверять проперти
        props: ["todo"],
        data() {
          return {
            timerId: null,
          };
        },
        watch: {
          "todo.status"(newStatus) {
            if (newStatus === "active") {
              this.timerId = setInterval(() => {
                this.todo.currentDuration++;
              }, 1000);
            } else {
              clearInterval(this.timerId);
            }
          },
          "todo.currentDuration"(val) {
            if (val === this.todo.maxDuration) {
              this.todo.status = "done";
            }
          },
        },
        methods: {
          // TODO: заменить на moment.js
          secondsToTime(e) {
            const minutes = Math.floor((e % 3600) / 60)
              .toString()
              .padStart(2, "0");

            const seconds = Math.floor(e % 60)
              .toString()
              .padStart(2, "0");

            return minutes + ":" + seconds;
          },
          startTimer() {
            if (this.todo.status === "done") {
              this.todo.currentDuration = 0;
            }
            this.todo.status = "active";
          },
          pauseTimer() {
            this.todo.status = "paused";
          },
          toggleStatus() {
            this.todo.status === "done"
              ? (this.todo.status = "new")
              : (this.todo.status = "done");
          },
        },
      });

      app.component("todo-form", {
        template: `
                <div class="todo-item">
                  <i
                    :class="{
                  'lar': true,
                  'la-clock': todoType === 'timer',
                  'la-circle': todoType === 'text'
                }"
                    @click="todoType === 'timer' ? todoType = 'text' : todoType = 'timer'"
                  ></i>
                  <!-- TODO: убрать бордер при фокусе на инпут -->
                  <input v-model="todoTitle" placeholder="Type your todo"  type="text" class='todo-title' />
                  <!-- TODO: принимать человекочитаемый инпут, а не секунды --> 
                  <input v-if="todoType === 'timer'" class='todo-title' placeholder="and time in seconds" v-model="todoMaxDuration" type="text" inputmode="numeric" pattern="\d*">
                  <i
                    class='lar la-save'
                    @click="process"
                  ></i>
                </div>
              `,
        name: "TodoForm",
        data() {
          return {
            todoType: "text",
            todoTitle: "",
            todoMaxDuration: null,
          };
        },
        watch: {
          todoType(newType, oldValue) {
            if (newType === "time") {
              this.todoMaxDuration = 0;
            }
            if (newType === "text") {
              this.todoMaxDuration = null;
            }
          },
        },
        methods: {
          process() {
            if (this.todoTitle === "") {
              return;
            }
            if (this.todoType === "timer") {
              if (
                this.todoMaxDuration == 0 ||
                this.todoMaxDuration === null ||
                this.todoMaxDuration === undefined
              ) {
                return;
              }
              this.$emit(
                "requestTodoCreation",
                this.todoTitle,
                this.todoType,
                this.todoMaxDuration
              );
            } else {
              this.$emit("requestTodoCreation", this.todoTitle, this.todoType);
            }
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
